{{ header }}{{ column_left }}
<div id="content">
    <div class="page-header">
        <div class="container-fluid">
            <h1>{{heading_title}}</h1>
            <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="container-fluid">
        {% if error_warning %}
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> <?php echo $error_warning; ?>
            <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}

        {% if success %}
        <div class="alert alert-success"><i class="fa fa-check-circle"></i> <?php echo $success; ?>
            <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-pencil"></i> {{text_edit}}</h3>
            </div>
            <div class="panel-body">
                <form action="{{action}}" method="post" enctype="multipart/form-data" id="form-pilibaba" class="form-horizontal">
                    <ul class="nav nav-tabs">
                        <li class="active" id="li-tab-settings"><a href="#tab-templates" data-toggle="tab">{{tab_template}}</a></li>
                        <li id="li-tab-settings"><a href="#tab-2" data-toggle="tab">{{tab_users}}</a></li>
                        <li id="li-tab-settings"><a href="#tab-3" data-toggle="tab">{{tab_mailing}}</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab-templates"> {# 1 TAB TEMPLATE #}
                        <div class="form-group required">
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_template_name }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="template_name" value="{{ mailing.name }}" placeholder="{{ entry_name }}" id="input-name{{ language.language_id }}" class="form-control"/>
                                    {% if error_name[language.language_id] %}
                                        <div class="text-danger">{{ error_name[language.language_id] }}</div>
                                    {% endif %} 
                                </div>
                            </div>
                            <div class="form-group required">
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_letter_theme }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="letter_theme" value="{{ mailing_description.letter_theme }}" placeholder="{{ entry_name }}" id="input-name{{ language.language_id }}" class="form-control"/>
                                    {% if error_name[language.language_id] %}
                                        <div class="text-danger">{{ error_name[language.language_id] }}</div>
                                    {% endif %} 
                                </div>
                            </div>
                            <div class="form-group required">
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_letter_text }}</label>
                                <div class="col-sm-10">
                                    <textarea name="letter_text" placeholder="{{ entry_description }}" id="input-description{{ language.language_id }}" data-toggle="summernote" data-lang="{{ summernote }}" class="form-control">{{ mailing_description.letter_text }}</textarea>
                                    {% if error_name[language.language_id] %}
                                        <div class="text-danger">{{ error_name[language.language_id] }}</div>
                                    {% endif %} 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-tax-class">{{ entry_products }}</label>
                                <div class="col-sm-10">
                                    <select name="categories" id="input-product-categories" class="form-control">
{#                                         <option selected value="{{ categories[0].category_id }}">{{ categories[0].name }}</option>#}

                                        {% for category in categories %}

                                            <option value="{{ category.category_id }}">{{ category.name }}</option>

                                        {% endfor %}

                                    </select>

                                    {# TODO #}
                                    <div class="row products-list">

                                    </div>


                                </div>
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_added_products }}</label>
                                <div class="col-sm-10">
                                    <div class="row added-products-list">

                                        {% for mailing_product in mailing_products %}

                                        <div data-product-id="{{ mailing_product.product_id }}" class="product-layout product-list col-sm-3 col-xs-12" style="border: 1px solid #e3e3e3; border-radius: 10px; margin-left: 15px; margin-top: 15px; padding: 10px; width: 15%;">
                                            <div class="product-thumb">
                                                <div class="image">
                                                    {% if mailing_product.image %}
                                                        <img src="/image/{{ mailing_product.image }}" alt="{{ mailing_product.name }}" title="{{ mailing_product.name }}" class="img-responsive" />
                                                    {% else %}
                                                        <img src="/image/cache/no_image-100x100.png" alt="{{ mailing_product.name }}" title="{{ mailing_product.name }}" class="img-responsive" />
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <div class="caption">
                                                        <p>{{ mailing_product.name }}</p>
                                                        <p class="price">
                                                            {{ mailing_product.price}}
                                                        </p>
                                                        <div class="button-group">
                                                            <button type="button" onclick="deleteProductFromMailing({{ mailing_product.product_id }})">
                                                                Удалить из рассылки
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        {% endfor %}

                                    </div>
                                </div>

                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_social }}</label>
                                <div class="col-sm-10">
                                    <div class="social-fields">

                                        {% for mailing_social_link in mailing_social_links %}

                                            <div style="margin-bottom: 15px;">
                                                <div class="col-sm-2">
                                                    <input type="text" name="social_icon[]" value="{{ mailing_social_link.icon }}" placeholder="{{ entry_icon_code }}" id="input-name{{ language.language_id }}" class="form-control"/>
                                                </div>
                                                <div class="col-sm-9">
                                                    <input type="text" name="social_link[]" value="{{ mailing_social_link.link }}" placeholder="{{ entry_link }}" id="input-name{{ language.language_id }}" class="form-control"/>
                                                </div>
                                                <span onclick="$(this).parent().remove()" class="btn btn-danger"><i class="fa fa-trash-o"></i></span>
                                            </div>

                                        {% endfor %}

                                    </div>
                                    <div class="col-sm-11"></div>
                                    <span class="btn btn-primary" onclick="addSocialField()"><i class="fa fa-plus"></i></span>
                                </div>

                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary">{{ button_save }}</button>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-2"> {# 2 TAB USERS #}
                            <table class="table table-bordered table-hover">
                                <thead>
                                <tr>
                                    <td style="width: 1px;" class="text-center"><input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);" /></td>
                                    <td class="text-left">{% if sort == 'name' %} <a href="{{ sort_email }}" class="{{ order|lower }}">{{ column_email }}</a> {% else %} <a href="{{ sort_email }}">{{ column_email }}</a> {% endif %}</td> {# TODO SORT #}
                                    <td class="text-left">{% if sort == 'c.email' %} <a href="{{ sort_name }}" class="{{ order|lower }}">{{ column_name }}</a> {% else %} <a href="{{ sort_name }}">{{ column_name }}</a> {% endif %}</td>
                                </tr>
                                </thead>
                                <tbody>

                                {% if customers %}
                                    {% for customer in customers %}
                                        <tr>
                                            <td class="text-center">
                                                {% if customer.customer_id in mailing_customers %}
                                                    <input type="checkbox" name="mailing_customers[]" value="{{ customer.customer_id }}" checked="checked" />
                                                {% else %}
                                                    <input type="checkbox" name="mailing_customers[]" value="{{ customer.customer_id }}" />
                                                {% endif %}
                                            </td>
                                            <td class="text-left">{{ customer.email }}</td>
                                            <td class="text-left">
                                                {{ customer.name }}
                                                <span class="pull-right">
                                                    <a href="index.php?route=customer/customer/edit&user_token={{ user_token }}&customer_id={{ customer.customer_id }}" data-toggle="tooltip" title="{{ button_edit }}" class="btn btn-primary"><i class="fa fa-pencil"></i></a>
                                                    <a href="#" data-customer-id="{{ customer.customer_id }}" data-toggle="tooltip" title="{{ button_delete }}" class="btn btn-danger unsubscribe-customer"><i class="fa fa-trash-o"></i></a>
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td class="text-center" colspan="8">{{ text_no_results }}</td>
                                    </tr>
                                {% endif %}
                                </tbody>
                            </table>
                            <div class="text-center">
                                <button class="btn btn-primary">{{ button_select_all }}</button>
                                <button class="btn btn-primary">{{ button_select_marked }}</button>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-3"> {# 3 TAB MAILING #}
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_count_letters }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="count_letters" value="{{ mailing.counter_letters }}" placeholder="{{ entry_name }}" id="input-name{{ language.language_id }}" class="form-control"/>
                                    {% if error_name[language.language_id] %}
                                        <div class="text-danger">{{ error_name[language.language_id] }}</div>
                                    {% endif %} 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-name">{{ entry_date_automailing }}</label>
                                <div class="col-sm-10">
                                    <input type="datetime-local" name="date_automailing" value="{{ mailing.date_start }}" placeholder="{{ entry_name }}" id="input-name{{ language.language_id }}" class="form-control"/>
                                    {% if error_name[language.language_id] %}
                                        <div class="text-danger">{{ error_name[language.language_id] }}</div>
                                    {% endif %} 
                                </div>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-primary">{{ button_start }}</button>
                                <button class="btn btn-primary">{{ button_start_by_date }}</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    @media (min-width: 768px) {
        #button-register, #img_loading_register {
            position: relative;
            left: 5px;
        }
    }
</style>
<link href="view/javascript/summernote/summernote.css" rel="stylesheet"/>
<script type="text/javascript" src="view/javascript/summernote/summernote.js"></script>
<script type="text/javascript" src="view/javascript/summernote/summernote-image-attributes.js"></script>
<script type="text/javascript" src="view/javascript/summernote/opencart.js"></script>

<script type="text/javascript">

    function addSocialField() {
        $('.social-fields').append(
            '<div style="margin-bottom: 15px;">' +
                '<div class="col-sm-2">' +
                    '<input type="text" name="social_icon[]" value="" placeholder="{{ entry_icon_code }}" id="input-name{{ language.language_id }}" class="form-control"/>' +
                '</div>' +
                '<div class="col-sm-9">' +
                    '<input type="text" name="social_link[]" value="" placeholder="{{ entry_link }}" id="input-name{{ language.language_id }}" class="form-control"/>' +
                '</div>' +
                '<span onclick="$(this).parent().remove()" class="btn btn-danger"><i class="fa fa-trash-o"></i></span>' +
            '</div>'
        )
    }

    function deleteProductFromMailing(product_id) {
        $('.added-products-list').find("[data-product-id='" + product_id + "']").appendTo(".products-list")
        $('.products-list').find("[data-product-id='" + product_id + "']").find('.button-group').html(
            '<button type="button" onclick="addProductToMailing(' + product_id + ')"> Добавить в рассылку</button>'
        )
    }

    function addProductToMailing(product_id) {
        $('.products-list').find("[data-product-id='" + product_id + "']").appendTo(".added-products-list")
        $('.added-products-list').find("[data-product-id='" + product_id + "']").find('.button-group').html(
            '<button type="button" onclick="deleteProductFromMailing(' + product_id + ')"> Удалить из рассылки</button>' +
            '<input type="hidden" name="added_products_id[]" id="added-product-id" value="' + product_id + '" />'
        )
    }

    function getProductsByCategoryId() {
        let category_id = $("#input-product-categories option:selected").val()

        $.ajax({
            url: 'index.php?route=extension/module/mailing/getproducts&user_token={{ user_token }}&category_id=' + category_id,
            dataType: 'json',
            // beforeSend: function() {
            //     $('#button-setting').button('loading');
            // },
            // complete: function() {
            //     $('#button-setting').button('reset');
            // },
            success: function(products) {
                $('.products-list').empty();
                products.forEach(function (val, key) {
                    let product_image = val.thumb ? val.thumb : "/image/cache/no_image-100x100.png"

                    let isAdded = $('.added-products-list').find("[data-product-id='" + val.product_id + "']").length

                    if(!isAdded) {

                        $('.products-list').append(
                            '<div data-product-id="'+val.product_id+'" class="product-layout product-list col-sm-3 col-xs-12" style="border: 1px solid #e3e3e3; border-radius: 10px; margin-left: 15px; margin-top: 15px; padding: 10px; width: 15%;' +
                                '<div class="product-thumb">' +
                                    '<div class="image"><img src="'+ product_image + '" alt="'+ val.name +'" title="'+ val.name +'" class="img-responsive" /></div>' +
                                        '<div>' +
                                            '<div class="caption">' +
                                                '<p>' + val.name + '</p>' +
                                                '<p class="price">' +
                                                    val.price +
                                                '</p>' +
                                                '<div class="button-group">' +
                                                    '<button type="button" onclick="addProductToMailing(' + val.product_id + ')">' +
                                                    'Добавить в рассылку' +
                                                    '</button>' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>'
                        )
                    }
                })
                // $('#modal-developer').remove();
                //
                // $('body').prepend('<div id="modal-developer" class="modal">' + html + '</div>');
                //
                // $('#modal-developer').modal('show');
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    }

    $(document).ready(function() {
        getProductsByCategoryId()
        $('#input-product-categories').on('change', getProductsByCategoryId)
    })
</script>
{{footer}}